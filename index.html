<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>WebAuthn / SPC Demo – montant affiché</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script>
/********************************************************************************************
*  DEMO PASSKEY + SECURE PAYMENT CONFIRMATION (SPC)
*  -----------------------------------------------------------------------------------------
*  ◼ Enrôlement d'une *payment credential*  ➜  navigator.credentials.create({ isPaymentCredential:true })
*     Spécification : Secure Payment Confirmation §3.3 « Payment credential enrollment »
*
*  ◼ Paiement avec affichage OS (montant + commerçant)  ➜  PaymentRequest + SPC method
*     Spécification : SPC WD §4 « PaymentRequest flow »
*
*  ◼ Fallback transaction simple  ➜  extension WebAuthn `txAuthSimple`
*     Spécification : WebAuthn L2 §10.2  (note : l'affichage dépend du support plateforme)
********************************************************************************************/

const ORIGIN = `https://greglibert.github.io`;       // utilisé dans SPC

/********** Outils **********/ 
const b64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
const rng = n => crypto.getRandomValues(new Uint8Array(n));

/********** State ***********/
const S = { userId: rng(16), credId: null };   // simple mémoire

/*******************************************************************************************
 * ENRÔLEMENT Payment Credential (isPaymentCredential=true)
 * -----------------------------------------------------------------------------------------
 * Cette call prépare un passkey **taguée paiement**. Les navigateurs affichent ensuite une
 * UI spécialisée « Carte / Montant ». Basé sur la démo publique de R. Solomakhin :
 * https://rsolomakhin.github.io/pr/spc/
 *******************************************************************************************/
async function enrollPaymentCredential() {
  const opts = {
    isPaymentCredential: true,                    // *** indispensable ***
    challenge: rng(32),
    rp: { name: 'Demo Bank' },
    user: { id: S.userId, name: 'alice@example.com', displayName: 'Alice' },
    pubKeyCredParams: [{ type:'public-key', alg:-7 }],
    authenticatorSelection: {
      authenticatorAttachment: 'platform',       // paiement = platform de préférence
      residentKey: 'required',
      userVerification: 'required'
    },
    timeout: 60000,
    extensions:{ credProps:true }
  };
  console.log('[Enroll‑PayCred] →', opts);
  try {
    const cred = await navigator.credentials.create({ publicKey: opts });
    S.credId = cred.rawId;
    console.log('[Enroll‑PayCred] OK', b64(cred.rawId));
    alert('✅ Credential paiement créée');
  } catch(e){ console.error('[Enroll‑PayCred] KO', e); alert('❌ '+e.message); }
}

/*******************************************************************************************
 * Paiement SECURE PAYMENT CONFIRMATION
 * -----------------------------------------------------------------------------------------
 * L'UI système doit afficher : logo carte, montant, commerçant. Chrome ≥ 123, Edge idem.
 *******************************************************************************************/
async function paySPC() {
  if(!S.credId){ alert('Pas de credential, faites l\'enrôlement.'); return; }
  const challenge = rng(32);
  const amount   = '11.00';

  const supported = 'PaymentRequest' in window && await PaymentRequest.isSecurePaymentConfirmationSupported?.();
  if(!supported){ alert('SPC non supporté – essayez Chrome 123+ / Edge.'); return; }

  const pr = new PaymentRequest([
    {
      supportedMethods: 'secure-payment-confirmation',
      data: {
        action: 'authenticate',
        credentialIds: [ S.credId ],
        challenge,
        instrument: {
          displayName: 'Visa ‑‑1234',
          icon: ORIGIN + '/card-icon.png'        // optionnel
        },
        payeeName: 'Boutique Demo',
        payeeOrigin: ORIGIN,
        timeout: 60000
      }
    }
  ], {
    total: { label:'Total', amount:{ currency:'EUR', value: amount } }
  });

  try {
    const resp = await pr.show();
    await resp.complete('success');
    console.log('[SPC] success', resp);
    alert('✅ Paiement SPC confirmé');
  } catch(e){ console.error('[SPC] KO', e); alert('❌ '+e.message); }
}

/*******************************************************************************************
 * txAuthSimple – affichage texte (si support OS)
 * -----------------------------------------------------------------------------------------
 * La plupart des plateformes n'affichent pas encore `txAuthSimple` ; seule Android 14
 * + Play services >= 24.22 et Chrome 124 montrent le texte. Cette démo reste un fallback
 * fonctionnel mais l'UX peut être silencieuse.
 *******************************************************************************************/
async function payTxAuthSimpleFallback(){
  if(!S.credId){ alert('Pas de credential, faites l\'enrôlement.'); return; }
  const challenge = rng(32);
  const amount='9.99';
  const opts = {
    challenge,
    allowCredentials:[{ id:S.credId, type:'public-key', transports:['hybrid','usb','ble','nfc'] }],
    authenticatorSelection:{ authenticatorAttachment:'cross-platform' },
    hints:['hybrid'],
    userVerification:'required',
    timeout:60000,
    extensions:{ txAuthSimple:`Payer ${amount} € à Boutique Demo` }
  };
  console.log('[txAuthSimple] →', opts);
  try{
    const cred = await navigator.credentials.get({ publicKey: opts });
    console.log('[txAuthSimple] success', cred); alert('✅ Signature txAuthSimple OK');
  }catch(e){ console.error('[txAuthSimple] KO', e); alert('❌ '+e.message); }
}
</script>
<style>
body{font-family:system-ui,sans-serif;display:flex;flex-direction:column;align-items:center;margin-top:2.5rem;gap:1rem}
button{padding:0.8rem 1.7rem;font-size:1rem;border:none;border-radius:0.75rem;background:#2563eb;color:#fff;cursor:pointer;transition:transform .15s;max-width:340px}
button:hover{transform:scale(1.05)}
</style>
</head>
<body>
<h1>SPC · txAuthSimple Demo</h1>
<button onclick="enrollPaymentCredential()">Enrôlement Payment Credential</button>
<button onclick="paySPC()">Tester Secure Payment Confirmation</button>
<button onclick="payTxAuthSimpleFallback()">Tester txAuthSimple (QR cross‑device)</button>
<p>Déployez sur GitHub Pages et ouvrez l’URL sur Chrome 123+.<br>Sur Android 14, le texte `txAuthSimple` devrait apparaître ; sinon l’OS peut l’ignorer.</p>
</body>
</html>
