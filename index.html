<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SPC / Passkey Demo – version alignée rsolomakhin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script>
/************************************************************************************************
 *  Demo inspirée du code officiel Secure Payment Confirmation (SPC)
 *  https://rsolomakhin.github.io/pr/spc/
 *  ---------------------------------------------------------------
 *  1. createPaymentCredential()   – enrôle une *payment credential* (isPaymentCredential:true)
 *  2. payWithSPC()                – lance PaymentRequest + méthode "secure-payment-confirmation"
 *  3. payWithTxAuthSimple()       – fallback `txAuthSimple` cross‑device
 *
 *  Les appels de disponibilité suivent la même logique que la démo d'origine :
 *    • PaymentRequest.securePaymentConfirmationAvailability()
 *    • PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
 ************************************************************************************************/

const RP_ID   = "greglibert.github.io";                  // <— votre GH Pages hostname
const ORIGIN  = `https://${RP_ID}`;                       // besoin pour SPC payeeOrigin
const STORAGE_KEY = 'demoPayCredRawId';                   // localStorage key

/********************************* HELPERS *********************************************/
const toB64 = ab => btoa(String.fromCharCode(...new Uint8Array(ab))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
const fromB64 = b64 => Uint8Array.from(atob(b64.replace(/-/g,'+').replace(/_/g,'/')), c=>c.charCodeAt(0)).buffer;
const rand = n => crypto.getRandomValues(new Uint8Array(n));

/********************************* ENRÔLEMENT ******************************************/
/**
 * Enrôle une *payment credential* (isPaymentCredential=true)
 * Spec: SPC §3.3 « Payment Credential Enrollment »
 */
async function createPaymentCredential(){
  const userId = rand(16);
  const opts = {
    isPaymentCredential: true,
    challenge: rand(32),
    rp:{ name:'Demo Bank'},
    user:{ id:userId, name:'alice@example.com', displayName:'Alice'},
    pubKeyCredParams:[{ type:'public-key', alg:-7 }],
    authenticatorSelection:{ authenticatorAttachment:'platform', residentKey:'required', userVerification:'required' },
    timeout:60000
  };
  console.log('[Enroll] options', opts);
  try{
    const cred = await navigator.credentials.create({ publicKey: opts });
    localStorage.setItem(STORAGE_KEY, toB64(cred.rawId));
    console.log('[Enroll] SUCCESS', cred);
    alert('✅ Payment Credential enregistrée');
  }catch(e){ console.error('[Enroll] error', e); alert('❌ '+e.message); }
}

/********************************* SPC PAYMENT ******************************************/
/**
 * Crée le PaymentRequest SPC (fonction utilitaire identique à la démo originale).
 */
function buildSPCPaymentRequest(amountEUR, challenge){
  return new PaymentRequest([
    {
      supportedMethods: 'secure-payment-confirmation',
      data: {
        action: 'authenticate',
        credentialIds: [ fromB64(localStorage.getItem(STORAGE_KEY)) ],
        challenge,
        instrument:{ displayName:'Visa —1234' },
        payeeName: 'Boutique Demo',
        payeeOrigin: ORIGIN,
        timeout: 60000,
        browserBoundPubKeyCredParams:[
          { type:'public-key', alg:-7 },
          { type:'public-key', alg:-257 }
        ]
      }
    }
  ], {
    total:{ label:'Total', amount:{ currency:'EUR', value:amountEUR } }
  });
}

async function payWithSPC(){
  if(!localStorage.getItem(STORAGE_KEY)){ alert('Enrôlez d\'abord la payment credential'); return; }

  // ✔ Vérification disponibilité SPC (exactement comme la démo rsolomakhin)
  if(!PaymentRequest || !PaymentRequest.securePaymentConfirmationAvailability){
    alert('PaymentRequest.securePaymentConfirmationAvailability() non dispo');
    return;
  }
  const available = await PaymentRequest.securePaymentConfirmationAvailability();
  console.log('[SPC] availability =', available);
  if(!available){ alert('SPC non supporté sur ce navigateur'); return; }

  const challenge = rand(32);
  const request = buildSPCPaymentRequest('11.00', challenge);

  try{
    const canMake = await request.canMakePayment();
    console.log('[SPC] canMakePayment =', canMake);
  }catch(e){ console.warn('[SPC] canMakePayment error', e); }

  try{
    const resp = await request.show();
    await resp.complete('success');
    console.log('[SPC] SUCCESS', resp);
    alert('✅ Paiement SPC validé');
  }catch(e){ console.error('[SPC] show() error', e); alert('❌ '+e.message); }
}

/********************************* FALLBACK txAuthSimple ********************************/
async function payWithTxAuthSimple(){
  if(!localStorage.getItem(STORAGE_KEY)){ alert('Enrôlez d\'abord'); return; }
  const challenge = rand(32);
  const opts = {
    challenge,
    allowCredentials:[{ id: fromB64(localStorage.getItem(STORAGE_KEY)), type:'public-key', transports:['hybrid','usb','ble','nfc'] }],
    authenticatorSelection:{ authenticatorAttachment:'cross-platform' },
    hints:['hybrid'], timeout:60000, userVerification:'required',
    extensions:{ txAuthSimple:'Payer 9,99 € à Boutique Demo' }
  };
  console.log('[txAuthSimple] opts', opts);
  try{
    const cred = await navigator.credentials.get({ publicKey: opts });
    console.log('[txAuthSimple] SUCCESS', cred);
    alert('✅ Signature txAuthSimple');
  }catch(e){ console.error('[txAuthSimple] error', e); alert('❌ '+e.message); }
}

/********************************* Tests de disponibilité ********************************/
if(PublicKeyCredential?.isUserVerifyingPlatformAuthenticatorAvailable){
  PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
    .then(av=>console.log('UVPAA =', av))
    .catch(e=>console.warn('UVPAA error', e));
}
if(PaymentRequest?.securePaymentConfirmationAvailability){
  PaymentRequest.securePaymentConfirmationAvailability()
    .then(av=>console.log('SPC availability =', av))
    .catch(e=>console.warn('SPC availability error', e));
}
</script>
<style>
body{font-family:system-ui,sans-serif;display:flex;flex-direction:column;align-items:center;margin-top:2.6rem;gap:1rem}
button{padding:0.8rem 1.7rem;font-size:1rem;border:none;border-radius:0.75rem;background:#2563eb;color:#fff;cursor:pointer;transition:transform .15s;max-width:340px}
button:hover{transform:scale(1.05)}
</style>
</head>
<body>
<h1>Secure Payment Confirmation Demo</h1>
<button onclick="createPaymentCredential()">1️⃣ Enrôler une payment credential</button>
<button onclick="payWithSPC()">2️⃣ Tester le paiement SPC (montant affiché)</button>
<button onclick="payWithTxAuthSimple()">3️⃣ Fallback txAuthSimple (cross‑device)</button>
<p>Assurez‑vous d'utiliser Chrome 123+ ou Edge équivalent. Sur mobile Android 14 le texte txAuthSimple
sera affiché si l'extension est supportée.</p>
</body>
</html>
