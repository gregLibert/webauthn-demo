<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SPC / Passkey Demo – version alignée rsolomakhin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script>
/*****************************************************************************************
 *  DEMO SPC  – version sans méthode dédiée de détection
 *  --------------------------------------------------------------------------------------
 *  1. createPaymentCredential()      – enrôle une payment‑credential (isPaymentCredential:true)
 *  2. payWithSPC()                   – tente SPC ; la disponibilité est déduite via
 *                                     PaymentRequest.canMakePayment() sur une requête témoin
 *  3. payWithTxAuthSimple()          – fallback cross‑device `txAuthSimple`
 *****************************************************************************************/

const STORAGE_KEY = 'spcDemoRawId';            // localStorage
const toB64 = ab => btoa(String.fromCharCode(...new Uint8Array(ab))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
const fromB64 = b64 => Uint8Array.from(atob(b64.replace(/-/g,'+').replace(/_/g,'/')),c=>c.charCodeAt(0)).buffer;
const rnd = n => crypto.getRandomValues(new Uint8Array(n));

/******************************** 1. ENRÔLEMENT ***********************************/
/**
 * Spécification : https://w3c.github.io/secure-payment-confirmation/#sctn-create-creds
 */
async function createPaymentCredential(){
  try{
    const cred = await navigator.credentials.create({ publicKey:{
      isPaymentCredential:true,
      challenge:rnd(32),
      rp:{ name:'Demo Bank' },          // pas de rp.id → le navigateur déduit l’host courant
      user:{ id:rnd(16), name:'alice@example.com', displayName:'Alice' },
      pubKeyCredParams:[{ type:'public-key', alg:-7 }],
      authenticatorSelection:{ authenticatorAttachment:'platform', residentKey:'required', userVerification:'required' },
      timeout:60000
    }});
    localStorage.setItem(STORAGE_KEY, toB64(cred.rawId));
    console.log('[Enroll] OK', cred);
    alert('✅ Payment credential enregistrée');
  }catch(e){ console.error('[Enroll] KO', e); alert('❌ '+e.message); }
}

/*********************** utilitaire détection SPC ***************************/
/**
 *   Approche recommandée dans les issues du groupe SPC : créer une requête factice
 *   (0 € + challenge bidon) et appeler canMakePayment().
 */
async function isSPCSupported(){
  if(!('PaymentRequest' in window)){ return false; }
  try{
    const probe = new PaymentRequest([
      { supportedMethods:'secure-payment-confirmation', data:{
          action:'authenticate',
          credentialIds:[ new Uint8Array(1) ],
          challenge:new Uint8Array(1),
          instrument:{ displayName:'x', icon:'data:image/png;base64,iVBORw0KGgo=' },
          payeeOrigin:'https://dummy.example'
        }}
    ],{ total:{ label:'dummy', amount:{ currency:'USD', value:'0' } } });
    return await probe.canMakePayment();
  }catch(e){ console.warn('[SPC] probe error', e); return false; }
}

/******************************** 2. PAIEMENT SPC *********************************/
async function payWithSPC(){
  if(!localStorage.getItem(STORAGE_KEY)){ alert('Enrôlez d\'abord'); return; }
  if(!(await isSPCSupported())){
    alert('SPC non disponible, utilisez le bouton fallback.');
    return;
  }

  const request = new PaymentRequest([
    { supportedMethods:'secure-payment-confirmation', data:{
        action:'authenticate',
        credentialIds:[ fromB64(localStorage.getItem(STORAGE_KEY)) ],
        challenge:rnd(32),
        instrument:{ displayName:'Visa —1234' },
        payeeName:'Boutique Demo',
        payeeOrigin:location.origin,
        timeout:60000 }
    }
  ],{ total:{ label:'Total', amount:{ currency:'EUR', value:'11.00' } } });

  try{
    const resp = await request.show();
    await resp.complete('success');
    console.log('[SPC] success', resp);
    alert('✅ Paiement SPC validé');
  }catch(e){ console.error('[SPC] KO', e); alert('❌ '+e.message); }
}

/******************************** 3. FALLBACK txAuthSimple ***********************/
async function payWithTxAuthSimple(){
  if(!localStorage.getItem(STORAGE_KEY)){ alert('Enrôlez d\'abord'); return; }
  const opts = { challenge:rnd(32),
    allowCredentials:[{ id:fromB64(localStorage.getItem(STORAGE_KEY)), type:'public-key', transports:['hybrid','usb','ble','nfc'] }],
    authenticatorSelection:{ authenticatorAttachment:'cross-platform' }, hints:['hybrid'],
    userVerification:'required', timeout:60000,
    extensions:{ txAuthSimple:'Payer 9,99 € à Boutique Demo' } };
  try{
    const cred = await navigator.credentials.get({ publicKey: opts });
    console.log('[txAuthSimple] success', cred);
    alert('✅ Signature txAuthSimple');
  }catch(e){ console.error('[txAuthSimple] KO', e); alert('❌ '+e.message); }
}
</script>
<style>
body{font-family:system-ui,sans-serif;display:flex;flex-direction:column;align-items:center;margin-top:2.6rem;gap:1rem}
button{padding:0.8rem 1.7rem;font-size:1rem;border:none;border-radius:0.75rem;background:#2563eb;color:#fff;cursor:pointer;transition:transform .15s;max-width:340px}
button:hover{transform:scale(1.05)}
</style>
</head>
<body>
<h1>Secure Payment Confirmation Demo</h1>
<button onclick="createPaymentCredential()">1️⃣ Enrôler une payment credential</button>
<button onclick="payWithSPC()">2️⃣ Tester le paiement SPC (montant affiché)</button>
<button onclick="payWithTxAuthSimple()">3️⃣ Fallback txAuthSimple (cross‑device)</button>
<p>Assurez‑vous d'utiliser Chrome 123+ ou Edge équivalent. Sur mobile Android 14 le texte txAuthSimple
sera affiché si l'extension est supportée.</p>
</body>
</html>
